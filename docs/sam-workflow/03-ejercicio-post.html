<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>03 Ejercicio Post - Goikode Serverless Secure Course</title>
    <link rel="stylesheet" href="../styles/goikode-docs.css">
</head>
<body>
    <!-- Header with logo and student prefix -->
    <header class="doc-header">
        <div class="doc-header-left">
            <a href="../index.html" class="logo-link">
                <img src="../assets/brand/logo.svg" alt="Goikode" class="doc-logo" onerror="this.src='../assets/brand/logo.png'">
            </a>
            <h1 class="doc-title">03 Ejercicio Post</h1>
        </div>
        <div class="doc-header-right">
            <div class="student-prefix-display">
                <span class="student-prefix-label">Tu prefijo:</span>
                <span id="header-student-prefix">-</span>
            </div>
            <button id="change-prefix-btn">Cambiar Prefijo</button>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>√çndice del Curso</h2>
            <button class="sidebar-toggle" id="sidebar-toggle">‚úï</button>
        </div>
        <div class="sidebar-content" id="sidebar-content">
            <div class="sidebar-loading">Cargando √≠ndice...</div>
        </div>
    </aside>

    <!-- Toggle button for mobile -->
    <button class="sidebar-open-btn" id="sidebar-open-btn">‚ò∞</button>

    <!-- Main content container -->
    <div class="doc-container with-sidebar">
        <div class="doc-content">
            <h1 id="ejercicio-guiado-anadir-endpoint-post-vinilos">Ejercicio Guiado: A√±adir Endpoint POST /vinilos</h1>
<h2 id="ampliar-tu-api-sam-paso-a-paso">Ampliar Tu API SAM Paso a Paso</h2>
<hr />
<h2 id="que-vas-a-hacer">üéØ Qu√© Vas a Hacer</h2>
<p>Vas a <strong>ampliar tu aplicaci√≥n SAM</strong> a√±adiendo un nuevo endpoint para crear vinilos. Aprender√°s a:</p>
<ol>
<li>A√±adir una nueva funci√≥n Lambda al template</li>
<li>Crear el c√≥digo del handler</li>
<li>Actualizar un stack SAM existente</li>
<li>Probar operaciones de escritura en DynamoDB</li>
</ol>
<p><strong>Resultado final</strong>:<br />
- ‚úÖ GET /vinilos (ya existe)<br />
- ‚úÖ <strong>POST /vinilos (nuevo)</strong> ‚Üê Esto es lo que vas a crear</p>
<hr />
<h2 id="antes-de-empezar">üìã Antes de Empezar</h2>
<h3 id="prerequisitos">Prerequisitos</h3>
<ul>
<li>‚úÖ Completaste el ejercicio anterior (despliegue base)</li>
<li>‚úÖ Tienes el stack <code>{tu-prefijo}-vinilos-stack</code> desplegado</li>
<li>‚úÖ La API GET /vinilos funciona correctamente</li>
</ul>
<h3 id="verificar-que-todo-esta-ok">Verificar que todo est√° OK</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Verificar que el stack existe</span>
aws<span class="w"> </span>cloudformation<span class="w"> </span>describe-stacks<span class="w"> </span>--stack-name<span class="w"> </span><span class="o">{</span>tu-prefijo<span class="o">}</span>-vinilos-stack<span class="w"> </span>--query<span class="w"> </span><span class="s1">&#39;Stacks[0].StackStatus&#39;</span><span class="w"> </span>--output<span class="w"> </span>text
</code></pre></div>

<p><strong>Debe mostrar</strong>: <code>CREATE_COMPLETE</code></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Verificar que est√°s en el directorio correcto</span>
<span class="nb">pwd</span>
</code></pre></div>

<p><strong>Debe mostrar</strong>: <code>.../sam-example</code></p>
<hr />
<h2 id="paso-1-crear-directorio-del-nuevo-handler">üìù Paso 1: Crear Directorio del Nuevo Handler</h2>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>src/handlers/create-vinilo
</code></pre></div>

<p><strong>Verificar</strong>:</p>
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>-la<span class="w"> </span>src/handlers/
</code></pre></div>

<p><strong>Debe mostrar</strong>:</p>
<div class="highlight"><pre><span></span><code>drwxr-xr-x  create-vinilo/
drwxr-xr-x  get-vinilos/
</code></pre></div>

<hr />
<h2 id="paso-2-crear-el-codigo-del-handler">üíª Paso 2: Crear el C√≥digo del Handler</h2>
<h3 id="21-crear-archivo-indexjs">2.1 Crear archivo index.js</h3>
<div class="highlight"><pre><span></span><code>nano<span class="w"> </span>src/handlers/create-vinilo/index.js
</code></pre></div>

<h3 id="22-copiar-este-codigo-completo">2.2 Copiar este c√≥digo COMPLETO</h3>
<p><strong>Copia y pega TODO el siguiente c√≥digo</strong> (son 172 l√≠neas):</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Create Vinilo Handler</span>
<span class="cm"> *</span>
<span class="cm"> * Creates a new vinyl record in DynamoDB</span>
<span class="cm"> */</span>

<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">DynamoDBClient</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@aws-sdk/client-dynamodb&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">DynamoDBDocumentClient</span><span class="p">,</span><span class="w"> </span><span class="nx">PutCommand</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@aws-sdk/lib-dynamodb&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">randomUUID</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">);</span>

<span class="c1">// Initialize DynamoDB Document Client</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">ddbClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DynamoDBClient</span><span class="p">({</span><span class="w"> </span><span class="nx">region</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REGION</span><span class="w"> </span><span class="p">});</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">docClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">DynamoDBDocumentClient</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">ddbClient</span><span class="p">);</span>

<span class="c1">// Environment variables (injected by SAM template)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">TABLE_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TABLE_NAME</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Validate vinyl data</span>
<span class="cm"> *</span>
<span class="cm"> * @param {Object} vinilo - Vinyl data to validate</span>
<span class="cm"> * @returns {Object} { valid: boolean, errors: string[] }</span>
<span class="cm"> */</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">validateVinilo</span><span class="p">(</span><span class="nx">vinilo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="c1">// Required fields</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">titulo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">titulo</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">titulo</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;titulo es requerido y debe ser un string no vac√≠o&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">artista</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">artista</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">artista</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;artista es requerido y debe ser un string no vac√≠o&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">precio</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">precio</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;precio es requerido&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">precio</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">precio</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;precio debe ser un n√∫mero mayor que 0&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Optional fields validation</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">a√±o</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">a√±o</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">a√±o</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;number&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">a√±o</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1900</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">a√±o</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">getFullYear</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`a√±o debe ser un n√∫mero entre 1900 y </span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">getFullYear</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">imagen_key</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">.</span><span class="nx">imagen_key</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;imagen_key debe ser un string&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">valid</span><span class="o">:</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">errors</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Lambda handler</span>
<span class="cm"> *</span>
<span class="cm"> * @param {Object} event - API Gateway HTTP API event</span>
<span class="cm"> * @returns {Object} HTTP response with statusCode, headers, body</span>
<span class="cm"> */</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Lambda invocada - POST vinilo&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Event:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Parse request body</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">body</span><span class="p">;</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">body</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;{}&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">parseError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error parsing JSON:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">parseError</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">statusCode</span><span class="o">:</span><span class="w"> </span><span class="mf">400</span><span class="p">,</span>
<span class="w">                </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">                    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Request body inv√°lido&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">mensaje</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;El body debe ser JSON v√°lido&#39;</span>
<span class="w">                </span><span class="p">})</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Validate vinyl data</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">validation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">validateVinilo</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">validation</span><span class="p">.</span><span class="nx">valid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Validation errors:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">validation</span><span class="p">.</span><span class="nx">errors</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">statusCode</span><span class="o">:</span><span class="w"> </span><span class="mf">400</span><span class="p">,</span>
<span class="w">                </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">                    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Datos de vinilo inv√°lidos&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">errores</span><span class="o">:</span><span class="w"> </span><span class="nx">validation</span><span class="p">.</span><span class="nx">errors</span>
<span class="w">                </span><span class="p">})</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Generate ID if not provided</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">randomUUID</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Build vinyl item for DynamoDB</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">vinilo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">id</span><span class="p">,</span>
<span class="w">            </span><span class="nx">titulo</span><span class="o">:</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">titulo</span><span class="p">.</span><span class="nx">trim</span><span class="p">(),</span>
<span class="w">            </span><span class="nx">artista</span><span class="o">:</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">artista</span><span class="p">.</span><span class="nx">trim</span><span class="p">(),</span>
<span class="w">            </span><span class="nx">precio</span><span class="o">:</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">precio</span><span class="p">,</span>
<span class="w">            </span><span class="nx">a√±o</span><span class="o">:</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">a√±o</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">            </span><span class="nx">imagen_key</span><span class="o">:</span><span class="w"> </span><span class="nx">body</span><span class="p">.</span><span class="nx">imagen_key</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;placeholder.jpg&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">            </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// Put item into DynamoDB</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">TableName</span><span class="o">:</span><span class="w"> </span><span class="nx">TABLE_NAME</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Item</span><span class="o">:</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">,</span>
<span class="w">            </span><span class="c1">// Prevent overwriting existing item with same ID</span>
<span class="w">            </span><span class="nx">ConditionExpression</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;attribute_not_exists(id)&#39;</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Inserting into DynamoDB:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">TABLE_NAME</span><span class="p">);</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">docClient</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">PutCommand</span><span class="p">(</span><span class="nx">params</span><span class="p">));</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Vinilo created successfully:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Return successful response</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">statusCode</span><span class="o">:</span><span class="w"> </span><span class="mf">201</span><span class="p">,</span><span class="w"> </span><span class="c1">// Created</span>
<span class="w">            </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST, OPTIONS&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">                </span><span class="nx">mensaje</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Vinilo creado exitosamente&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">vinilo</span><span class="o">:</span><span class="w"> </span><span class="nx">vinilo</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error al crear vinilo:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Handle DynamoDB conditional check failure (duplicate ID)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ConditionalCheckFailedException&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">statusCode</span><span class="o">:</span><span class="w"> </span><span class="mf">409</span><span class="p">,</span><span class="w"> </span><span class="c1">// Conflict</span>
<span class="w">                </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">                    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Vinilo ya existe&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">mensaje</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Ya existe un vinilo con ese ID&#39;</span>
<span class="w">                </span><span class="p">})</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Return generic error response</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">statusCode</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span>
<span class="w">            </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">                </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Error al crear vinilo&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">mensaje</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
<span class="w">                </span><span class="nx">tipo</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>Guardar y salir</strong> (Ctrl+O, Enter, Ctrl+X).</p>
<hr />
<h2 id="paso-3-crear-packagejson">üì¶ Paso 3: Crear package.json</h2>
<div class="highlight"><pre><span></span><code>nano<span class="w"> </span>src/handlers/create-vinilo/package.json
</code></pre></div>

<p><strong>Copia y pega este c√≥digo</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;create-vinilo-handler&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Lambda handler for creating vinyl records in DynamoDB&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;index.js&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;@aws-sdk/client-dynamodb&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^3.700.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;@aws-sdk/lib-dynamodb&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^3.700.0&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Guardar y salir</strong> (Ctrl+O, Enter, Ctrl+X).</p>
<hr />
<h2 id="paso-4-instalar-dependencias">üìö Paso 4: Instalar Dependencias</h2>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>src/handlers/create-vinilo
npm<span class="w"> </span>install
</code></pre></div>

<p><strong>Output esperado</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="nx">added</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">2</span><span class="nx">s</span>
</code></pre></div>

<p><strong>Volver al directorio ra√≠z</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>../../..
<span class="nb">pwd</span>
</code></pre></div>

<p><strong>Debe mostrar</strong>: <code>.../sam-example</code></p>
<hr />
<h2 id="paso-5-anadir-funcion-al-template-sam">üìù Paso 5: A√±adir Funci√≥n al Template SAM</h2>
<p>Ahora vamos a editar <code>template.yaml</code> para a√±adir la nueva funci√≥n.</p>
<div class="highlight"><pre><span></span><code>nano<span class="w"> </span>template.yaml
</code></pre></div>

<h3 id="51-ubicar-donde-insertar">5.1 Ubicar d√≥nde insertar</h3>
<p>Busca esta l√≠nea (alrededor de l√≠nea 125):</p>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="nt">ApiId</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VinilosHttpApi</span>

<span class="w">  </span><span class="c1">##########################################################################</span>
<span class="w">  </span><span class="c1"># API Gateway HTTP API</span>
<span class="w">  </span><span class="c1">##########################################################################</span>
</code></pre></div>

<h3 id="52-insertar-antes-de-api-gateway-http-api">5.2 Insertar ANTES de "# API Gateway HTTP API"</h3>
<p>Coloca el cursor <strong>despu√©s de la l√≠nea <code>ApiId: !Ref VinilosHttpApi</code></strong> y <strong>antes de <code># API Gateway HTTP API</code></strong>.</p>
<p><strong>Inserta estas l√≠neas EXACTAMENTE</strong> (respetando indentaci√≥n):</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="c1">##########################################################################</span>
<span class="w">  </span><span class="c1"># Lambda Function - Create Vinilo</span>
<span class="w">  </span><span class="c1">##########################################################################</span>
<span class="w">  </span><span class="nt">CreateViniloFunction</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">FunctionName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="s">&#39;${StudentPrefix}-create-vinilo&#39;</span>
<span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">src/handlers/create-vinilo/</span>
<span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">index.handler</span>
<span class="w">      </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Creates a new vinyl record in DynamoDB</span>
<span class="w">      </span><span class="nt">Policies</span><span class="p">:</span>
<span class="w">        </span><span class="c1"># SAM Policy Templates - simplified IAM permissions</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">DynamoDBWritePolicy</span><span class="p">:</span>
<span class="w">            </span><span class="nt">TableName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VinilosTable</span>
<span class="w">      </span><span class="nt">Events</span><span class="p">:</span>
<span class="w">        </span><span class="c1"># API Gateway integration</span>
<span class="w">        </span><span class="nt">CreateVinilo</span><span class="p">:</span>
<span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HttpApi</span>
<span class="w">          </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">            </span><span class="nt">Path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/vinilos</span>
<span class="w">            </span><span class="nt">Method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">post</span>
<span class="w">            </span><span class="nt">ApiId</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VinilosHttpApi</span>
</code></pre></div>

<p><strong>‚ö†Ô∏è MUY IMPORTANTE</strong>: La indentaci√≥n debe coincidir exactamente con <code>GetVinilosFunction</code> arriba.</p>
<h3 id="53-verificar-indentacion">5.3 Verificar indentaci√≥n</h3>
<p>El bloque debe estar al <strong>mismo nivel</strong> que <code>GetVinilosFunction</code>:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">GetVinilosFunction</span><span class="p">:</span><span class="w">      </span><span class="c1"># ‚Üê 2 espacios</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w">              </span><span class="c1"># ‚Üê 4 espacios</span>

<span class="w">  </span><span class="nt">CreateViniloFunction</span><span class="p">:</span><span class="w">    </span><span class="c1"># ‚Üê 2 espacios (MISMO nivel que GetVinilosFunction)</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w">              </span><span class="c1"># ‚Üê 4 espacios</span>
</code></pre></div>

<hr />
<h2 id="paso-6-anadir-output-para-nueva-funcion">üì§ Paso 6: A√±adir Output para Nueva Funci√≥n</h2>
<p>Busca la secci√≥n <code>Outputs</code> (alrededor de l√≠nea 162):</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">GetVinilosFunctionArn</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Lambda Function ARN</span>
<span class="w">    </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GetVinilosFunction.Arn</span>
<span class="w">    </span><span class="nt">Export</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="s">&#39;${StudentPrefix}-GetVinilosFunctionArn&#39;</span>

<span class="w">  </span><span class="nt">VinilosTableName</span><span class="p">:</span>
</code></pre></div>

<p><strong>Inserta DESPU√âS de <code>GetVinilosFunctionArn</code></strong> y <strong>ANTES de <code>VinilosTableName</code></strong>:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">CreateViniloFunctionArn</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Lambda Function ARN (POST)</span>
<span class="w">    </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CreateViniloFunction.Arn</span>
<span class="w">    </span><span class="nt">Export</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="s">&#39;${StudentPrefix}-CreateViniloFunctionArn&#39;</span>
</code></pre></div>

<p><strong>Guardar y salir</strong> (Ctrl+O, Enter, Ctrl+X).</p>
<hr />
<h2 id="paso-7-actualizar-cors-en-api-gateway">üì§ Paso 7: Actualizar CORS en API Gateway</h2>
<p>Busca la secci√≥n <code>CorsConfiguration</code> en el template (alrededor de l√≠nea 135):</p>
<div class="highlight"><pre><span></span><code><span class="w">      </span><span class="nt">CorsConfiguration</span><span class="p">:</span>
<span class="w">        </span><span class="nt">AllowOrigins</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
<span class="w">        </span><span class="nt">AllowMethods</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GET</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OPTIONS</span>
<span class="w">        </span><span class="nt">AllowHeaders</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;*&#39;</span>
</code></pre></div>

<p><strong>Cambia</strong> <code>AllowMethods</code> para incluir POST:</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="nt">AllowMethods</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GET</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POST</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OPTIONS</span>
</code></pre></div>

<p><strong>Guardar y salir</strong> (Ctrl+O, Enter, Ctrl+X).</p>
<hr />
<h2 id="paso-8-validar-el-template">‚úÖ Paso 8: Validar el Template</h2>
<p>Antes de desplegar, valida que no hay errores de sintaxis:</p>
<div class="highlight"><pre><span></span><code>sam<span class="w"> </span>validate
</code></pre></div>

<p><strong>Output esperado</strong>:</p>
<div class="highlight"><pre><span></span><code>/path/to/sam-example/template.yaml is a valid SAM Template
</code></pre></div>

<p>‚ùå <strong>Si ves errores</strong>:<br />
- Verifica la indentaci√≥n (usa espacios, NO tabs)<br />
- Aseg√∫rate de que copiaste TODO el bloque<br />
- Compara con el template original</p>
<hr />
<h2 id="paso-9-build">üèóÔ∏è Paso 9: Build</h2>
<div class="highlight"><pre><span></span><code>sam<span class="w"> </span>build
</code></pre></div>

<p><strong>Output esperado</strong> (ahora con 2 funciones):</p>
<div class="highlight"><pre><span></span><code>Building codeuri: /path/to/src/handlers/get-vinilos runtime: nodejs20.x
Running NodejsNpmBuilder:NpmPack
...
Building codeuri: /path/to/src/handlers/create-vinilo runtime: nodejs20.x
Running NodejsNpmBuilder:NpmPack
...

Build Succeeded

Built Artifacts  : .aws-sam/build
Built Template   : .aws-sam/build/template.yaml
</code></pre></div>

<p><strong>Verificar que se construyeron ambas funciones</strong>:</p>
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>-la<span class="w"> </span>.aws-sam/build/
</code></pre></div>

<p><strong>Debe mostrar</strong>:</p>
<div class="highlight"><pre><span></span><code>CreateViniloFunction/
GetVinilosFunction/
template.yaml
</code></pre></div>

<hr />
<h2 id="paso-10-deploy-actualizacion-del-stack">üöÄ Paso 10: Deploy (Actualizaci√≥n del Stack)</h2>
<p>Ahora despliega los cambios:</p>
<div class="highlight"><pre><span></span><code>sam<span class="w"> </span>deploy
</code></pre></div>

<p><strong>‚ö†Ô∏è NOTA</strong>: Ya NO usamos <code>--guided</code> porque <code>samconfig.toml</code> tiene la configuraci√≥n guardada.</p>
<p><strong>Output esperado</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c">Uploading to juan</span><span class="nb">-</span><span class="c">perez</span><span class="nb">-</span><span class="c">a7b3f</span><span class="nb">-</span><span class="c">vinilos/xxxxx</span><span class="nt">.</span><span class="c">zip</span>

<span class="c">Waiting for changeset to be created</span><span class="nt">...</span>

<span class="c">CloudFormation stack changeset</span>
<span class="nb">---------------------------------------------------------------------</span>
<span class="c">Operation            LogicalResourceId             ResourceType</span>
<span class="nb">---------------------------------------------------------------------</span>
<span class="nb">+</span><span class="c"> Add                CreateViniloFunction          AWS::Lambda::Function</span>
<span class="nb">+</span><span class="c"> Add                CreateViniloFunctionRole      AWS::IAM::Role</span>
<span class="nb">+</span><span class="c"> Add                CreateViniloFunctionCreate    AWS::Lambda::Permission</span>
<span class="c">* Modify             VinilosHttpApi                AWS::ApiGatewayV2::Api</span>
<span class="nb">---------------------------------------------------------------------</span>

<span class="c">Changeset created successfully</span><span class="nt">.</span>

<span class="c">Deploy this changeset? </span><span class="k">[</span><span class="c">y/N</span><span class="k">]</span><span class="c">:</span>
</code></pre></div>

<p><strong>Escribe</strong>: <code>y</code> y presiona Enter</p>
<p><strong>Continuar√°</strong>:</p>
<div class="highlight"><pre><span></span><code>UPDATE_IN_PROGRESS                     AWS::CloudFormation::Stack              juan-perez-a7b3f-vinilos-stack
CREATE_IN_PROGRESS                     AWS::IAM::Role                          CreateViniloFunctionRole
CREATE_IN_PROGRESS                     AWS::IAM::Role                          CreateViniloFunctionRole
CREATE_COMPLETE                        AWS::IAM::Role                          CreateViniloFunctionRole
CREATE_IN_PROGRESS                     AWS::Lambda::Function                   CreateViniloFunction
CREATE_IN_PROGRESS                     AWS::Lambda::Function                   CreateViniloFunction
CREATE_COMPLETE                        AWS::Lambda::Function                   CreateViniloFunction
UPDATE_IN_PROGRESS                     AWS::ApiGatewayV2::Api                  VinilosHttpApi
UPDATE_COMPLETE                        AWS::ApiGatewayV2::Api                  VinilosHttpApi
CREATE_IN_PROGRESS                     AWS::Lambda::Permission                 CreateViniloFunctionCreate
CREATE_COMPLETE                        AWS::Lambda::Permission                 CreateViniloFunctionCreate
UPDATE_COMPLETE                        AWS::CloudFormation::Stack              juan-perez-a7b3f-vinilos-stack
</code></pre></div>

<p>‚è±Ô∏è <strong>Tiempo</strong>: 1-2 minutos (m√°s r√°pido que el deploy inicial)</p>
<p><strong>Outputs actualizados</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="nv">Outputs</span>
<span class="o">------------------------------------------------------------------------</span>
<span class="nv">Key</span><span class="w">                 </span><span class="nv">VinilosApiUrl</span>
<span class="nv">Description</span><span class="w">         </span><span class="nv">API</span><span class="w"> </span><span class="nv">Gateway</span><span class="w"> </span><span class="nv">endpoint</span><span class="w"> </span><span class="nv">URL</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">Vinyl</span><span class="w"> </span><span class="nv">catalog</span>
<span class="nv">Value</span><span class="w">               </span><span class="nv">https</span>:<span class="o">//</span><span class="nv">abcd1234</span>.<span class="nv">execute</span><span class="o">-</span><span class="nv">api</span>.<span class="nv">eu</span><span class="o">-</span><span class="nv">west</span><span class="o">-</span><span class="mi">1</span>.<span class="nv">amazonaws</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">vinilos</span>

<span class="nv">Key</span><span class="w">                 </span><span class="nv">CreateViniloFunctionArn</span><span class="w">    </span>‚Üê<span class="w"> </span><span class="nv">NUEVO</span>
<span class="nv">Description</span><span class="w">         </span><span class="nv">Lambda</span><span class="w"> </span><span class="nv">Function</span><span class="w"> </span><span class="nv">ARN</span><span class="w"> </span><span class="ss">(</span><span class="nv">POST</span><span class="ss">)</span>
<span class="nv">Value</span><span class="w">               </span><span class="nv">arn</span>:<span class="nv">aws</span>:<span class="nv">lambda</span>:<span class="nv">eu</span><span class="o">-</span><span class="nv">west</span><span class="o">-</span><span class="mi">1</span>:<span class="mi">123456789012</span>:<span class="nv">function</span>:<span class="nv">juan</span><span class="o">-</span><span class="nv">perez</span><span class="o">-</span><span class="nv">a7b3f</span><span class="o">-</span><span class="nv">create</span><span class="o">-</span><span class="nv">vinilo</span>

<span class="nv">Key</span><span class="w">                 </span><span class="nv">GetVinilosFunctionArn</span>
...
<span class="o">------------------------------------------------------------------------</span>

<span class="nv">Successfully</span><span class="w"> </span><span class="nv">updated</span><span class="w"> </span><span class="nv">stack</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">juan</span><span class="o">-</span><span class="nv">perez</span><span class="o">-</span><span class="nv">a7b3f</span><span class="o">-</span><span class="nv">vinilos</span><span class="o">-</span><span class="nv">stack</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">eu</span><span class="o">-</span><span class="nv">west</span><span class="o">-</span><span class="mi">1</span>
</code></pre></div>

<p>üéâ <strong>¬°Stack actualizado!</strong> Ahora tienes 2 funciones Lambda en tu aplicaci√≥n.</p>
<hr />
<h2 id="paso-11-probar-post-vinilos">üß™ Paso 11: Probar POST /vinilos</h2>
<h3 id="111-obtener-url-de-la-api">11.1 Obtener URL de la API</h3>
<div class="highlight"><pre><span></span><code><span class="nv">API_URL</span><span class="o">=</span><span class="k">$(</span>aws<span class="w"> </span>cloudformation<span class="w"> </span>describe-stacks<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--stack-name<span class="w"> </span><span class="o">{</span>tu-prefijo<span class="o">}</span>-vinilos-stack<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--query<span class="w"> </span><span class="s1">&#39;Stacks[0].Outputs[?OutputKey==`VinilosApiUrl`].OutputValue&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--output<span class="w"> </span>text<span class="k">)</span>

<span class="nb">echo</span><span class="w"> </span><span class="nv">$API_URL</span>
</code></pre></div>

<p><strong>Reemplaza</strong> <code>{tu-prefijo}</code> con tu prefijo real.</p>
<h3 id="112-crear-un-vinilo-valido">11.2 Crear un vinilo v√°lido</h3>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="nv">$API_URL</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;titulo&quot;: &quot;Rumours&quot;,</span>
<span class="s1">    &quot;artista&quot;: &quot;Fleetwood Mac&quot;,</span>
<span class="s1">    &quot;precio&quot;: 24.99,</span>
<span class="s1">    &quot;a√±o&quot;: 1977,</span>
<span class="s1">    &quot;imagen_key&quot;: &quot;rumours.jpg&quot;</span>
<span class="s1">  }&#39;</span>
</code></pre></div>

<p><strong>Output esperado (201 Created)</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;mensaje&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Vinilo creado exitosamente&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;vinilo&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;f7d9c8a3-4b2e-4f1a-9d5c-8e7f6a5b4c3d&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;titulo&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Rumours&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;artista&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Fleetwood Mac&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;precio&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">24.99</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;a√±o&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1977</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;imagen_key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rumours.jpg&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;createdAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-01-15T12:34:56.789Z&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;updatedAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-01-15T12:34:56.789Z&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>‚úÖ <strong>Si ves status 201 y el vinilo creado, ¬°funciona!</strong></p>
<hr />
<h2 id="paso-12-verificar-que-aparece-en-get">üß™ Paso 12: Verificar que Aparece en GET</h2>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span><span class="nv">$API_URL</span>
</code></pre></div>

<p><strong>Output esperado</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;mensaje&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Cat√°logo de vinilos desde DynamoDB (SAM deployment)&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;total&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w">    </span><span class="err">‚Üê</span><span class="w"> </span><span class="err">Ahora</span><span class="w"> </span><span class="err">so</span><span class="kc">n</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="err">(los</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="err">origi</span><span class="kc">nales</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">Rumours)</span>
<span class="w">  </span><span class="nt">&quot;vinilos&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;titulo&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Abbey Road&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="err">...</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="err">...</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;f7d9c8a3-4b2e-4f1a-9d5c-8e7f6a5b4c3d&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;titulo&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Rumours&quot;</span><span class="p">,</span><span class="w">      </span><span class="err">‚Üê</span><span class="w"> </span><span class="err">EL</span><span class="w"> </span><span class="err">NUEVO</span><span class="w"> </span><span class="err">VINILO</span>
<span class="w">      </span><span class="nt">&quot;artista&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Fleetwood Mac&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;precio&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">24.99</span><span class="p">,</span>
<span class="w">      </span><span class="err">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>üéâ <strong>¬°Perfecto!</strong> El nuevo vinilo aparece en el cat√°logo.</p>
<hr />
<h2 id="paso-13-probar-validacion">üß™ Paso 13: Probar Validaci√≥n</h2>
<h3 id="131-intentar-crear-sin-campo-requerido">13.1 Intentar crear sin campo requerido</h3>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="nv">$API_URL</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;titulo&quot;: &quot;Hotel California&quot;,</span>
<span class="s1">    &quot;precio&quot;: 23.50</span>
<span class="s1">  }&#39;</span>
</code></pre></div>

<p><strong>Output esperado (400 Bad Request)</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Datos de vinilo inv√°lidos&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;errores&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;artista es requerido y debe ser un string no vac√≠o&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>‚úÖ <strong>Validaci√≥n funcionando correctamente</strong>.</p>
<h3 id="132-intentar-crear-con-precio-invalido">13.2 Intentar crear con precio inv√°lido</h3>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="nv">$API_URL</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;titulo&quot;: &quot;Led Zeppelin IV&quot;,</span>
<span class="s1">    &quot;artista&quot;: &quot;Led Zeppelin&quot;,</span>
<span class="s1">    &quot;precio&quot;: -10</span>
<span class="s1">  }&#39;</span>
</code></pre></div>

<p><strong>Output esperado (400 Bad Request)</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Datos de vinilo inv√°lidos&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;errores&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;precio debe ser un n√∫mero mayor que 0&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>‚úÖ <strong>Validaci√≥n de precio funcionando</strong>.</p>
<h3 id="133-intentar-crear-con-json-malformado">13.3 Intentar crear con JSON malformado</h3>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span><span class="nv">$API_URL</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{ titulo: &quot;Bad JSON&quot; }&#39;</span>
</code></pre></div>

<p><strong>Output esperado (400 Bad Request)</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Request body inv√°lido&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;mensaje&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;El body debe ser JSON v√°lido&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p>‚úÖ <strong>Validaci√≥n de JSON funcionando</strong>.</p>
<hr />
<h2 id="paso-14-ver-logs-de-create">üìù Paso 14: Ver Logs de CREATE</h2>
<div class="highlight"><pre><span></span><code>sam<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>CreateViniloFunction<span class="w"> </span>--stack-name<span class="w"> </span><span class="o">{</span>tu-prefijo<span class="o">}</span>-vinilos-stack<span class="w"> </span>--tail
</code></pre></div>

<p><strong>Haz otra petici√≥n POST</strong> en otra terminal para ver los logs:</p>
<p><strong>Output esperado</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="mf">2025</span><span class="o">-</span><span class="mf">01</span><span class="o">-</span><span class="mf">15</span><span class="n">T12</span><span class="p">:</span><span class="mf">45</span><span class="p">:</span><span class="mf">00.123000</span><span class="w"> </span><span class="n">START</span><span class="w"> </span><span class="n">RequestId</span><span class="p">:</span><span class="w"> </span><span class="n">xyz789</span>
<span class="mf">2025</span><span class="o">-</span><span class="mf">01</span><span class="o">-</span><span class="mf">15</span><span class="n">T12</span><span class="p">:</span><span class="mf">45</span><span class="p">:</span><span class="mf">00.456000</span><span class="w"> </span><span class="n">Lambda</span><span class="w"> </span><span class="n">invocada</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">POS</span><span class="n">T</span><span class="w"> </span><span class="n">vinilo</span>
<span class="mf">2025</span><span class="o">-</span><span class="mf">01</span><span class="o">-</span><span class="mf">15</span><span class="n">T12</span><span class="p">:</span><span class="mf">45</span><span class="p">:</span><span class="mf">00.789000</span><span class="w"> </span><span class="n">Event</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="mf">...</span><span class="w"> </span><span class="err">}</span>
<span class="mf">2025</span><span class="o">-</span><span class="mf">01</span><span class="o">-</span><span class="mf">15</span><span class="n">T12</span><span class="p">:</span><span class="mf">45</span><span class="p">:</span><span class="mf">01.012000</span><span class="w"> </span><span class="n">Inserting</span><span class="w"> </span><span class="nb">int</span><span class="n">o</span><span class="w"> </span><span class="n">DynamoDB</span><span class="p">:</span><span class="w"> </span><span class="n">juan</span><span class="o">-</span><span class="n">perez</span><span class="o">-</span><span class="n">a7b3f</span><span class="o">-</span><span class="n">vinilos</span>
<span class="mf">2025</span><span class="o">-</span><span class="mf">01</span><span class="o">-</span><span class="mf">15</span><span class="n">T12</span><span class="p">:</span><span class="mf">45</span><span class="p">:</span><span class="mf">01.345000</span><span class="w"> </span><span class="n">Vinilo</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">successfully</span><span class="p">:</span><span class="w"> </span><span class="n">f7d9c8a3</span><span class="o">-</span><span class="mf">...</span>
<span class="mf">2025</span><span class="o">-</span><span class="mf">01</span><span class="o">-</span><span class="mf">15</span><span class="n">T12</span><span class="p">:</span><span class="mf">45</span><span class="p">:</span><span class="mf">01.678000</span><span class="w"> </span><span class="kr">END</span><span class="w"> </span><span class="n">RequestId</span><span class="p">:</span><span class="w"> </span><span class="n">xyz789</span>
<span class="mf">2025</span><span class="o">-</span><span class="mf">01</span><span class="o">-</span><span class="mf">15</span><span class="n">T12</span><span class="p">:</span><span class="mf">45</span><span class="p">:</span><span class="mf">01.678000</span><span class="w"> </span><span class="n">REPORT</span><span class="w"> </span><span class="n">Duration</span><span class="p">:</span><span class="w"> </span><span class="mf">556</span><span class="n">ms</span><span class="w"> </span><span class="n">Memory</span><span class="p">:</span><span class="w"> </span><span class="mf">91</span><span class="n">MB</span>
</code></pre></div>

<p><strong>Presiona Ctrl+C</strong> para salir.</p>
<hr />
<h2 id="que-aprendiste">üéØ ¬øQu√© Aprendiste?</h2>
<table>
<thead>
<tr>
<th>Concepto</th>
<th>Qu√© hiciste</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>A√±adir recursos a SAM</strong></td>
<td>Editaste template.yaml y a√±adiste CreateViniloFunction</td>
</tr>
<tr>
<td><strong>DynamoDBWritePolicy</strong></td>
<td>SAM cre√≥ autom√°ticamente permisos IAM para escribir</td>
</tr>
<tr>
<td><strong>Actualizar stack</strong></td>
<td><code>sam deploy</code> sin --guided actualiz√≥ el stack existente</td>
</tr>
<tr>
<td><strong>Validaci√≥n de datos</strong></td>
<td>Implementaste validaci√≥n en el handler</td>
</tr>
<tr>
<td><strong>C√≥digos HTTP</strong></td>
<td>Usaste 201 (Created), 400 (Bad Request), 409 (Conflict)</td>
</tr>
<tr>
<td><strong>ConditionExpression</strong></td>
<td>Preveniste duplicados con <code>attribute_not_exists(id)</code></td>
</tr>
<tr>
<td><strong>randomUUID()</strong></td>
<td>Generaste IDs √∫nicos con m√≥dulo crypto de Node.js</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="analisis-del-codigo">üîç An√°lisis del C√≥digo</h2>
<h3 id="1-por-que-dynamodbwritepolicy">1. ¬øPor qu√© DynamoDBWritePolicy?</h3>
<div class="highlight"><pre><span></span><code><span class="nt">Policies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">DynamoDBWritePolicy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">TableName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VinilosTable</span>
</code></pre></div>

<p>SAM genera autom√°ticamente esta pol√≠tica IAM:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;dynamodb:PutItem&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;dynamodb:UpdateItem&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;dynamodb:DeleteItem&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:dynamodb:eu-west-1:123456789012:table/juan-perez-a7b3f-vinilos&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Sin SAM</strong>, tendr√≠as que escribir todo ese JSON manualmente.</p>
<h3 id="2-por-que-conditionexpression">2. ¬øPor qu√© ConditionExpression?</h3>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">TableName</span><span class="o">:</span><span class="w"> </span><span class="nx">TABLE_NAME</span><span class="p">,</span>
<span class="w">    </span><span class="nx">Item</span><span class="o">:</span><span class="w"> </span><span class="nx">vinilo</span><span class="p">,</span>
<span class="w">    </span><span class="nx">ConditionExpression</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;attribute_not_exists(id)&#39;</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>Con ConditionExpression</strong>:<br />
- Si el ID no existe ‚Üí Crea el item ‚úÖ<br />
- Si el ID existe ‚Üí Lanza error 409 Conflict ‚ùå</p>
<p><strong>Sin ConditionExpression</strong>:<br />
- DynamoDB <strong>sobrescribe</strong> el item existente sin avisar ‚ö†Ô∏è</p>
<h3 id="3-codigos-de-estado-http">3. C√≥digos de Estado HTTP</h3>
<table>
<thead>
<tr>
<th>C√≥digo</th>
<th>Cu√°ndo usar</th>
<th>Ejemplo</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>201</strong></td>
<td>Recurso creado exitosamente</td>
<td>Vinilo creado</td>
</tr>
<tr>
<td><strong>400</strong></td>
<td>Datos inv√°lidos (culpa del cliente)</td>
<td>JSON malformado, campo faltante</td>
</tr>
<tr>
<td><strong>409</strong></td>
<td>Conflicto (recurso ya existe)</td>
<td>ID duplicado</td>
</tr>
<tr>
<td><strong>500</strong></td>
<td>Error del servidor (culpa nuestra)</td>
<td>Error inesperado de DynamoDB</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="checklist-final">‚úÖ Checklist Final</h2>
<ul>
<li>[ ] Handler create-vinilo creado en <code>src/handlers/create-vinilo/</code></li>
<li>[ ] Dependencias instaladas (npm install)</li>
<li>[ ] Funci√≥n a√±adida a template.yaml</li>
<li>[ ] Output a√±adido para CreateViniloFunction</li>
<li>[ ] CORS actualizado para incluir POST</li>
<li>[ ] Template validado (<code>sam validate</code>)</li>
<li>[ ] Build ejecutado sin errores</li>
<li>[ ] Deploy ejecutado (stack updated)</li>
<li>[ ] POST crea vinilos correctamente (201)</li>
<li>[ ] Validaci√≥n rechaza datos inv√°lidos (400)</li>
<li>[ ] Nuevo vinilo aparece en GET</li>
<li>[ ] Logs visibles con <code>sam logs</code></li>
</ul>
<p>Si marcaste todo ‚úÖ, ¬°excelente trabajo!</p>
<hr />
<h2 id="troubleshooting">üêõ Troubleshooting</h2>
<h3 id="error-resource-with-id-createvinilofunction-already-exists">Error: "Resource with id [CreateViniloFunction] already exists"</h3>
<p><strong>Causa</strong>: Indentaci√≥n incorrecta en template.yaml.</p>
<p><strong>Soluci√≥n</strong>: Verifica que <code>CreateViniloFunction</code> est√© al mismo nivel que <code>GetVinilosFunction</code> (2 espacios de indentaci√≥n).</p>
<hr />
<h3 id="error-al-build-unable-to-find-source-code-at-srchandlerscreate-vinilo">Error al build: "Unable to find source code at 'src/handlers/create-vinilo/'"</h3>
<p><strong>Causa</strong>: Ruta incorrecta o directorio no creado.</p>
<p><strong>Soluci√≥n</strong>:</p>
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>-la<span class="w"> </span>src/handlers/
</code></pre></div>

<p>Debe mostrar <code>create-vinilo/</code> con <code>index.js</code> y <code>package.json</code> dentro.</p>
<hr />
<h3 id="deploy-falla-con-update_rollback_complete">Deploy falla con "UPDATE_ROLLBACK_COMPLETE"</h3>
<p><strong>Causa</strong>: Error en el template o en c√≥digo Lambda.</p>
<p><strong>Soluci√≥n</strong>: Ver logs detallados:</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>cloudformation<span class="w"> </span>describe-stack-events<span class="w"> </span>--stack-name<span class="w"> </span><span class="o">{</span>tu-prefijo<span class="o">}</span>-vinilos-stack<span class="w"> </span>--max-items<span class="w"> </span><span class="m">10</span>
</code></pre></div>

<hr />
<h3 id="post-devuelve-403-missing-authentication-token">POST devuelve 403 "Missing Authentication Token"</h3>
<p><strong>Causa</strong>: CORS no actualizado o m√©todo no permitido.</p>
<p><strong>Soluci√≥n</strong>: Verifica que <code>AllowMethods</code> incluya POST en template.yaml (Paso 7).</p>
<hr />
<h3 id="post-devuelve-500">POST devuelve 500</h3>
<p><strong>Causa</strong>: Error en c√≥digo Lambda.</p>
<p><strong>Soluci√≥n</strong>: Ver logs:</p>
<div class="highlight"><pre><span></span><code>sam<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>CreateViniloFunction<span class="w"> </span>--stack-name<span class="w"> </span><span class="o">{</span>tu-prefijo<span class="o">}</span>-vinilos-stack
</code></pre></div>

<hr />
<h2 id="proximo-paso">üöÄ Pr√≥ximo Paso</h2>
<p>Ya sabes a√±adir endpoints a tu API SAM. Ahora un ejercicio m√°s aut√≥nomo:</p>
<p><strong><a href="./04-ejercicio-get-by-id.html">Ejercicio Aut√≥nomo: GET /vinilos/{id}</a></strong></p>
<p>En este ejercicio:<br />
- ‚úÖ Recibir√°s <strong>pistas</strong> en lugar de c√≥digo completo<br />
- ‚úÖ Tendr√°s que <strong>adaptar</strong> lo que aprendiste<br />
- ‚úÖ La <strong>soluci√≥n completa</strong> estar√° disponible en una rama Git para que compares</p>
<p>¬°Es tu momento de brillar! üåü</p>
        </div>
    </div>

    <!-- JavaScript for student prefix management -->
    <script src="../scripts/student-prefix.js"></script>
    <!-- JavaScript for sidebar navigation -->
    <script src="../scripts/sidebar-nav.js"></script>
    <!-- JavaScript for copy code buttons -->
    <script src="../scripts/copy-code.js"></script>
</body>
</html>